<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE æ‰“å¡ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; padding: 20px; }
        .btn { padding: 15px; margin: 10px; font-size: 18px; border: none; cursor: pointer; }
        .btn-start { background-color: #4CAF50; color: white; }
        .btn-end { background-color: #f44336; color: white; }
    </style>
</head>
<body>

    <h2>ğŸš€ LINE æ‰“å¡ç³»çµ±</h2>
    <p>ğŸ¢ å…¬å¸ä½ç½®: å°åŒ—101</p>
    <p>ğŸ“ ä½ çš„ä½ç½®: <span id="user-location">å–å¾—ä¸­...</span></p>
    <p>ğŸ“ è·é›¢: <span id="distance">è¨ˆç®—ä¸­...</span></p>

    <button class="btn btn-start" onclick="checkIn('ä¸Šç­')">ğŸ”µ ä¸Šç­æ‰“å¡</button>
    <button class="btn btn-end" onclick="checkIn('ä¸‹ç­')">ğŸ”´ ä¸‹ç­æ‰“å¡</button>

    <h3>ğŸ•’ æ‰“å¡è¨˜éŒ„</h3>
    <ul id="checkin-log"></ul>

    <script>
        let liffId = "ä½ çš„_LIFF_ID";
        let companyLat = 25.0330, companyLon = 121.5654;

        liff.init({ liffId })
            .then(() => { if (!liff.isLoggedIn()) liff.login(); })
            .catch(err => console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err));

        navigator.geolocation.getCurrentPosition(
            (position) => {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;
                document.getElementById("user-location").innerText = `${lat}, ${lon}`;
                calculateDistance(lat, lon);
            },
            (error) => { console.error("ç„¡æ³•å–å¾— GPS", error); }
        );

        function calculateDistance(lat, lon) {
            const R = 6371e3;
            const toRad = x => x * Math.PI / 180;
            let dLat = toRad(companyLat - lat);
            let dLon = toRad(companyLon - lon);
            let a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(toRad(lat)) * Math.cos(toRad(companyLat)) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            let distance = R * c;
            document.getElementById("distance").innerText = `${Math.round(distance)} å…¬å°º`;
        }

        function checkIn(type) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    let userId = liff.getDecodedIDToken()?.sub;

                    fetch("http://ä½ çš„ä¼ºæœå™¨/checkin", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ userId, latitude: lat, longitude: lon, type })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`${type} æ‰“å¡æˆåŠŸï¼`);
                            let log = document.getElementById("checkin-log");
                            let now = new Date().toLocaleTimeString();
                            log.innerHTML += `<li>âœ… ${now} ${type}</li>`;
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(err => console.error("æ‰“å¡å¤±æ•—", err));
                },
                (error) => { console.error("ç„¡æ³•å–å¾— GPS", error); }
            );
        }
    </script>
</body>
</html>
